# XS2184 PSE driver and monitor app

## 检测原理
- 正常工作时, PSE 协商使能, 供电给 PD, 并统计15轮 实时功耗;
- 当平均功耗 为0, 判定 PD 出现异常, 关闭 PSE 对应 Port的供电;
- 被关闭的 Port, 在下一轮统计时, 重新开启协商供电使能;
- 实测, MS1800K 在 上电复位异常情况下, 实时功耗 为0 mW, 能被识别出异常, 并断电重启;

## 测试方法
1. 正常 PoE - PD 组网;
2. 后台执行:  xs2184 -m 1000; 
3. xs2184 监听模式, 参数 -m: monitor 模式, 检测间隔 1000ms, 平均功耗计算周期: 默认 15 轮, -s <ms> 可修改;
4. 观察 xs2184 日志, 会实时打印功耗和检测状态;
5. 用镊子短路 MS1800K 的 C133 复位电容, 模拟上电无法启动的情况;
6. 重复4), 对比关电和重新上电的行为, 以及MS1800K重新开机和功耗变化;


## 测试场景 - 基本功能测试

### 显示
输入“xs2184 -c"，“帮助提示”是否显示所有命令选项
输入“xs2184 -c"，“帮助提示”是否显示输入的正确范围

### 配置uci

升级后是否有/etc/config/xs2184

更改uci，运行命令配置是否生效
	uci更改轮数、监控间隔、记录数据开关、记录点数
	uci set xs2184.globals.round=16
	uci set xs2184.globals.interval=2000
	uci set xs2184.globals.record_en=1
	uci set xs2184.globals.record_times=8640
	uci set xs2184.port7.enable=0
	uci set xs2184.port7.pc=300
	
	查看配置是否生效
	xs2184 -c

更改错误uci，运行命令配置是否自行更正为正确配置，并生效
	uci set xs2184.globals.round=10
	uci set xs2184.globals.interval=3
	uci set xs2184.globals.record_en=3
	uci set xs2184.globals.record_times=-1
	uci set xs2184.port7.enable=3
	uci set xs2184.port7.pc=-1
	查看配置是否生效
	xs2184 -c

### 开关端口是否正常
xs2184 -u 4 
AP设备接在AC的lan4口，lan4口灯亮
xs2184 -d 4
AP设备接在AC的lan4口，lan4口灯灭

xs2184 -u 6
在显示配置后提示write fail, 因为设备没有6端口
xs2184 -u 9 
提示输入帮助，因为端口9不在输入范围内
xs2184 -u -1
提示输入帮助，因为端口-1不在输入范围内


### 修改配置

更改轮数、监控间隔、记录数据的开关是否配置生效
xs2184 -s 19 -m 1000 -t 1

更改轮数、监控间隔、记录数据的开关，显示的配置的部分是否覆盖uci设置值

更改轮数、监控间隔、记录数据的开关，是否保存在uci配置
xs2184 -s 17 -m 1200 ; uci show xs2184.globals

更改异常轮数、监控间隔、记录数据的开关值，是否提示输入帮助
xs2184 -s 14 ; xs2184 -s 301
xs2184 -m 999 ; xs2184 -m 100001
xs2184 -t -1 ;  xs2184 -t 2

更改每个端口的功耗阈值，是否配置生效
xs2184 -u 2 -r 500
xs2184 -u 2 -u 6 -r 111
端口6生效的功耗阈值为111，输入多个-u选项，生效端口值是[-r][-t]选项前，且与其距离最近的端口

更改部分端口的功耗阈值，显示的配置的部分是否覆盖uci设置值

更改每个端口的功耗阈值,是否有保存在uci配置
xs2184 -u 4 -r 500 ;  uci show xs2184.port4

更改的端口的功耗阈值不在监测的电压范围内, 是否提示输入帮助
xs2184 -u 4 -r 100001 ; xs2184 -u 4 -r -1
更改的端口的功耗阈值缺生效端口, 是否提示输入帮助
xs2184 -r 222

### 监测功能

有监控选项前提下，只要配置正确，是否一定进入监控功能
xs2184 -s 19 -m 1000 -t 1

是否可以在开启监控功能同时，关闭记录功能
xs2184 -s 19 -m 1000 -t 0

每10s计算一次平均功耗，是否正确保存在/tmp/xs2184_record
xs2184 -m 1000
若否，请注意是否后台已经开启服务

每天计算一次平均功耗，是否正确保存在/tmp/xs2184_day_record
uci set xs2184.globals.record_times=8640
xs2184 -m 1000
若否，请注意是否后台已经开启服务

在开启监控功能后，在1分钟时重启监控功能，后续数据是否继续追加在文件/tmp/xs2184_record中

在开启监控功能后，/tmp/xs2184_record更新，后续数据是否继续追加在文件/tmp/xs2184_record中

在没有负载的情况下，开启监控功能持续1分钟，是否保存功耗数据